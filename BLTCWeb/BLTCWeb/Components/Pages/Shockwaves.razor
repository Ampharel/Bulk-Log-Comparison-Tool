@page "/shockwaves"
@using System.Net.Http.Json
@using MudBlazor
@using Bulk_Log_Comparison_Tool.DataClasses
@using System.Drawing;
@using System.Drawing.Drawing2D;
@using System.Drawing.Imaging;
@rendermode InteractiveServer

@inject ServerParser LogParser
@inject SpecFilterService SpecFilter
<LogDrawer OnUpload="StateHasChanged" />
<div style="overflow-x: auto;">
    <MudGrid>
        <MudItem>
        <MudTooltip Text="Player is dead when shockwave passes">
            <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(-1,"death").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudTooltip Text="Player got hit by shockwave, but was protected by stability">
                <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(-1,"shield").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudTooltip Text="Player did not get hit by the shockwave, and was protected by stability">
                <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(-1,"jumped").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudTooltip Text="Player is down when the shockwave hits them / gets downed by the shockwave">
                <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(-1,"down").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudTooltip Text="Player did not get hit by the shockwave, but also did not have stability">
                <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(-1,"warning").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudFlexBreak/>
        <MudTooltip Text="This colour represents mordremoth shockwaves">
            <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(0,"jumped").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudTooltip Text="This colour represents soo-won shockwaves">
            <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(1,"jumped").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
        <MudItem>
        <MudTooltip Text="This colour represents obliterator shockwaves">
            <MudImage Src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(imageGenerator.GetImage(2,"jumped").BytesFromImage()))" />
        </MudTooltip>
        </MudItem>
    </MudGrid>
    <MudTable Items="@LogParser.BulkLog.GetPlayers()"
              Hover="true"
              Dense="true"
              Breakpoint="Breakpoint.Sm"
              LoadingProgressColor="MudBlazor.Color.Info"
              Class="flex-table">
        <HeaderContent>
            <MudTh Class="sticky-col col-1">Player</MudTh>
            <MudTh Class="sticky-col col-2">Specializations</MudTh>
            @foreach (var log in GetFilteredLogs())
            {
                if(log.GetShockwaves(0).Count() > 0){
                <MudTh>@log.GetFileName()</MudTh>
                }
            }
        </HeaderContent>
        <RowTemplate>
            <MudTd Class="sticky-col col-1">@context</MudTd>
            <MudTd Class="sticky-col col-2">
                @{
                    var specs = LogParser.GetPlayerSpecs(context);
                    var images = imageGenerator.GetSpecializationImages(specs);
                    for (int i = 0; i < specs.Length; i++)
                    {
                        var specId = specs[i];
                        var filter = SpecFilter.IsEnabled(context, specId) ? "none" : "grayscale(1) opacity(0.5)";
                        var style = $"cursor:pointer; margin-right:4px; filter:{filter};";

                        <span style="@style" @onclick="@(() => SpecFilter.Toggle(context, specId))">
                            <MudImage ObjectPosition="@ObjectPosition.Center" Src="@($"data:image/png;base64,{Convert.ToBase64String(images[i].BytesFromImage())}")" />
                        </span>
                    }
                }
            </MudTd>
            @foreach(var log in GetFilteredLogs()){
                if(log.GetShockwaves(0).Count() > 0){
                    var data = GetImageForPlayer(log, @context);
                    if(data.Length > 0){
                    <MudTd>
                <MudImage src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(GetImageForPlayer(log, @context)))" />
                        </MudTd>
                    }
                    else
                    {
                    <MudTd/>
                        
                    }
                }
            }
        </RowTemplate>
    </MudTable>
</div>

@code {

    private WebImageGenerator imageGenerator = new WebImageGenerator();
    private byte[] GetImageForPlayer(IParsedEvtcLog Log, string Player)
    {
        var shockwaves = GetShockwaves(Log, 0);
        shockwaves = shockwaves.Concat(GetShockwaves(Log, 1)).ToList();
        shockwaves = shockwaves.Concat(GetShockwaves(Log, 2)).ToList();
        return imageGenerator.GetImageBytes(Log, Player, shockwaves); ;
    }

    private List<(long, int)> GetShockwaves(IParsedEvtcLog Log, int shockwaveType)
    {
        List<(long, int)> shockwaves = new();
        foreach (var shockwave in Log.GetShockwaves(shockwaveType))
        {
            shockwaves.Add((shockwave, shockwaveType));
        }
        return shockwaves;
    }

    private IParsedEvtcLog[] GetFilteredLogs()
    {
        return SpecFilter.FilterLogs(LogParser.BulkLog.Logs).ToArray();
    }
}
